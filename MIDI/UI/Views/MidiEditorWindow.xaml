<Window x:Class="MIDI.UI.Views.MidiEditorWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        xmlns:avalonDock="clr-namespace:AvalonDock;assembly=AvalonDock"
        xmlns:avalonDockLayout="clr-namespace:AvalonDock.Layout;assembly=AvalonDock"
        xmlns:avalonDockThemes="clr-namespace:AvalonDock.Themes;assembly=AvalonDock"
        xmlns:local="clr-namespace:MIDI.UI.ViewModels"
        xmlns:views="clr-namespace:MIDI.UI.Views"
        xmlns:editorPanels="clr-namespace:MIDI.UI.Views.MidiEditor.Panel"
        xmlns:editorConverters="clr-namespace:MIDI.UI.Views.MidiEditor.Converters"
        xmlns:midi="clr-namespace:MIDI"
        xmlns:models="clr-namespace:MIDI.Configuration.Models"
        xmlns:modals="clr-namespace:MIDI.UI.ViewModels.MidiEditor.Modals"
        mc:Ignorable="d"
        d:DataContext="{d:DesignInstance Type=local:MidiEditorViewModel}"
        Title="{Binding FileName, StringFormat='MIDIエディター - {0}'}"
        Height="768"
        Width="1280"
        WindowStartupLocation="CenterOwner"
        Background="{DynamicResource {x:Static SystemColors.WindowBrushKey}}"
        Foreground="{DynamicResource {x:Static SystemColors.ControlTextBrushKey}}"
        PreviewKeyDown="MidiEditorWindow_KeyDown"
        KeyUp="MidiEditorWindow_KeyUp">

    <Window.InputBindings>
    </Window.InputBindings>

    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="MidiEditor/Resources/MidiEditorResources.xaml" />
            </ResourceDictionary.MergedDictionaries>

            <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
            <editorConverters:BooleanToVisibilityInvertedConverter x:Key="BooleanToVisibilityInvertedConverter" />
            <editorConverters:NullToVisibilityConverterInverted x:Key="NullToVisibilityConverterInverted" />
            <editorConverters:EnumToBooleanConverter x:Key="EnumToBooleanConverter" />
            <editorConverters:InverseBooleanConverter x:Key="InverseBooleanConverter" />
            <editorConverters:AllTrueToVisibleMultiConverter x:Key="AllTrueToVisibleMultiConverter" />
            <editorConverters:HalfDurationConverter x:Key="halfDurationConverter" />
            <editorConverters:HalfWidthConverter x:Key="HalfWidthConverter" />

            <x:Static x:Key="DockTop" Member="Dock.Top" />
            <x:Static x:Key="DockBottom" Member="Dock.Bottom" />
            <x:Static x:Key="DockLeft" Member="Dock.Left" />
            <x:Static x:Key="DockRight" Member="Dock.Right" />
        </ResourceDictionary>
    </Window.Resources>

    <Grid>
        <DockPanel>
            <StatusBar DockPanel.Dock="Bottom">
                <StatusBarItem>
                    <TextBlock Text="{Binding StatusText}" />
                </StatusBarItem>
                <Separator />
                <StatusBarItem>
                    <TextBlock Text="{Binding CurrentTempoText}" />
                </StatusBarItem>
                <Separator />
                <StatusBarItem>
                    <TextBlock Text="{Binding SelectionStatusText}" />
                </StatusBarItem>
            </StatusBar>

            <DockPanel>
                <Menu DockPanel.Dock="Top">
                    <MenuItem Header="ファイル(_F)">
                        <MenuItem Header="新規作成(_N)" Command="{Binding NewCommand}" />
                        <MenuItem Header="MIDI 読み込み(_O)" Command="{Binding LoadMidiCommand}" />
                        <Separator/>
                        <MenuItem Header="プロジェクトを読み込み" Command="{Binding LoadProjectCommand}" />
                        <Separator/>
                        <MenuItem Header="MIDI 保存(_S)" Command="{Binding SaveCommand}" />
                        <MenuItem Header="MIDI 名前を付けて保存(_A)" Command="{Binding SaveAsCommand}" />
                        <Separator/>
                        <MenuItem Header="プロジェクトの保存" Command="{Binding SaveProjectCommand}" />
                        <MenuItem Header="プロジェクトを名前を付けて保存" Command="{Binding SaveProjectAsCommand}" />
                        <Separator/>
                        <MenuItem Header="オーディオ書き出し(_E)" Command="{Binding ExportAudioCommand}" />
                        <Separator />
                        <MenuItem Header="閉じる(_C)" Command="{Binding CloseMidiCommand}" />
                        <Separator />
                        <MenuItem Header="終了(_X)" Click="CloseMenuItem_Click" />
                    </MenuItem>
                    <MenuItem Header="編集(_E)">
                        <MenuItem Header="元に戻す(_U)" Command="{Binding UndoCommand}" />
                        <MenuItem Header="やり直し(_R)" Command="{Binding RedoCommand}" />
                        <Separator />
                        <MenuItem Header="コピー(_C)" Command="{Binding CopyCommand}" />
                        <MenuItem Header="貼り付け(_V)" Command="{Binding PasteCommand}" />
                        <MenuItem Header="削除(_D)" Command="{Binding DeleteSelectedNotesCommand}" />
                        <Separator />
                        <MenuItem Header="すべて選択(_A)" Command="{Binding SelectAllCommand}" />
                        <MenuItem Header="選択を反転" Command="{Binding InvertSelectionCommand}" />
                        <MenuItem Header="同じ音程のノートを選択" Command="{Binding SelectSamePitchCommand}" />
                        <MenuItem Header="同じチャンネルのノートを選択" Command="{Binding SelectSameChannelCommand}" />
                        <Separator />
                        <MenuItem Header="クオンタイズ設定(_Q)" Command="{Binding OpenQuantizeSettingsCommand}" />
                        <MenuItem Header="グリッドにスナップ" IsCheckable="True" IsChecked="{Binding EditorSettings.Grid.EnableSnapToGrid, Mode=TwoWay}" />
                        <MenuItem Header="ノート編集">
                            <MenuItem Header="移調(トランスポーズ)" Command="{Binding TransposeCommand}" />
                            <MenuItem Header="ベロシティの変更" Command="{Binding ChangeVelocityCommand}" />
                            <MenuItem Header="レガート" Command="{Binding LegatoCommand}" />
                            <MenuItem Header="スタッカート" Command="{Binding StaccatoCommand}" />
                            <MenuItem Header="ヒューマナイズ" Command="{Binding HumanizeCommand}" />
                            <Separator />
                            <MenuItem Header="長さを倍増" Command="{Binding DoubleDurationCommand}" />
                            <MenuItem Header="長さを半減" Command="{Binding HalveDurationCommand}" />
                            <MenuItem Header="ピッチを反転" Command="{Binding InvertPitchCommand}" />
                            <MenuItem Header="逆再生" Command="{Binding RetrogradeCommand}" />
                        </MenuItem>
                        <Separator />
                        <MenuItem Header="フラグ">
                            <MenuItem Header="次のフラグへ移動" Command="{Binding GoToNextFlagCommand}" />
                            <MenuItem Header="前のフラグへ移動" Command="{Binding GoToPreviousFlagCommand}" />
                            <Separator />
                            <MenuItem Header="選択したフラグを削除" Command="{Binding DeleteSelectedFlagsCommand}" />
                            <MenuItem Header="すべてのフラグを削除" Command="{Binding DeleteAllFlagsCommand}" />
                        </MenuItem>
                    </MenuItem>
                    <MenuItem Header="表示(_V)">
                        <MenuItem Header="追加の鍵盤表示">
                            <MenuItem Header="無効" Style="{StaticResource RadioMenuItemStyle}" IsChecked="{Binding AdditionalKeyLabel, ConverterParameter={x:Static models:AdditionalKeyLabelType.None}, Converter={StaticResource EnumToBooleanConverter}, Mode=TwoWay}" />
                            <MenuItem Header="ドレミ" Style="{StaticResource RadioMenuItemStyle}" IsChecked="{Binding AdditionalKeyLabel, ConverterParameter={x:Static models:AdditionalKeyLabelType.DoReMi}, Converter={StaticResource EnumToBooleanConverter}, Mode=TwoWay}" />
                            <MenuItem Header="イロハ" Style="{StaticResource RadioMenuItemStyle}" IsChecked="{Binding AdditionalKeyLabel, ConverterParameter={x:Static models:AdditionalKeyLabelType.Iroha}, Converter={StaticResource EnumToBooleanConverter}, Mode=TwoWay}" />
                        </MenuItem>
                        <Separator />
                        <MenuItem Header="表示設定" Command="{Binding OpenDisplaySettingsCommand}" />
                        <Separator />
                        <MenuItem Header="サムネイル表示" IsCheckable="True" IsChecked="{Binding ShowThumbnail, Mode=TwoWay}" />
                        <MenuItem Header="選択範囲にズーム" Command="{Binding ZoomToSelectionCommand}" />
                        <MenuItem Header="ズームをリセット" Command="{Binding ResetZoomCommand}" Visibility="{Binding IsZoomed, Converter={StaticResource BooleanToVisibilityConverter}}" />
                        <MenuItem Header="チャンネルごとに自動色分け" Command="{Binding ColorizeByChannelCommand}" />
                        <MenuItem Header="ノートの色をリセット" Command="{Binding ResetNoteColorCommand}" />
                    </MenuItem>
                    <MenuItem Header="ウィンドウ(_W)">
                        <MenuItem Header="ピアノロール" IsCheckable="True" IsChecked="{Binding IsPianoRollVisible, Mode=TwoWay}" />
                        <MenuItem Header="ノーツの編集" IsCheckable="True" IsChecked="{Binding IsNoteEditorVisible, Mode=TwoWay}" />
                        <MenuItem Header="クオンタイズ設定" IsCheckable="True" IsChecked="{Binding IsQuantizeSettingsVisible, Mode=TwoWay}" />
                        <MenuItem Header="再生設定" IsCheckable="True" IsChecked="{Binding IsPlaybackSettingsVisible, Mode=TwoWay}" />
                        <MenuItem Header="メトロノーム" IsCheckable="True" IsChecked="{Binding IsMetronomeVisible, Mode=TwoWay}" />
                        <MenuItem Header="テンポエディター" IsCheckable="True" IsChecked="{Binding IsTempoEditorVisible, Mode=TwoWay}" />
                        <MenuItem Header="コントロールチェンジ" IsCheckable="True" IsChecked="{Binding IsControlChangeEditorVisible, Mode=TwoWay}" />
                        <MenuItem Header="サウンドピーク" IsCheckable="True" IsChecked="{Binding IsSoundPeakVisible, Mode=TwoWay}" />
                    </MenuItem>
                    <MenuItem Header="設定(_T)">
                        <MenuItem Header="エディター設定" Command="{Binding OpenEditorSettingsCommand}" />
                        <MenuItem Header="ツールバーの位置">
                            <MenuItem Header="上" IsCheckable="True" IsChecked="{Binding ToolbarDock, ConverterParameter={x:Static Dock.Top}, Converter={StaticResource EnumToBooleanConverter}}" Command="{Binding SetToolbarDockCommand}" CommandParameter="{StaticResource DockTop}" />
                            <MenuItem Header="下" IsCheckable="True" IsChecked="{Binding ToolbarDock, ConverterParameter={x:Static Dock.Bottom}, Converter={StaticResource EnumToBooleanConverter}}" Command="{Binding SetToolbarDockCommand}" CommandParameter="{StaticResource DockBottom}" />
                            <MenuItem Header="左" IsCheckable="True" IsChecked="{Binding ToolbarDock, ConverterParameter={x:Static Dock.Left}, Converter={StaticResource EnumToBooleanConverter}}" Command="{Binding SetToolbarDockCommand}" CommandParameter="{StaticResource DockLeft}" />
                            <MenuItem Header="右" IsCheckable="True" IsChecked="{Binding ToolbarDock, ConverterParameter={x:Static Dock.Right}, Converter={StaticResource EnumToBooleanConverter}}" Command="{Binding SetToolbarDockCommand}" CommandParameter="{StaticResource DockRight}" />
                        </MenuItem>
                        <MenuItem Header="MIDI入力モード">
                            <MenuItem Header="キーボードを鳴らす" Style="{StaticResource RadioMenuItemStyle}" IsChecked="{Binding MidiInputMode, ConverterParameter={x:Static local:MidiInputMode.Keyboard}, Converter={StaticResource EnumToBooleanConverter}, Mode=TwoWay}" />
                            <MenuItem Header="リアルタイムレンダー" Style="{StaticResource RadioMenuItemStyle}" IsChecked="{Binding MidiInputMode, ConverterParameter={x:Static local:MidiInputMode.Realtime}, Converter={StaticResource EnumToBooleanConverter}, Mode=TwoWay}" />
                            <MenuItem Header="PCキーボードで演奏" Style="{StaticResource RadioMenuItemStyle}" IsChecked="{Binding MidiInputMode, ConverterParameter={x:Static local:MidiInputMode.ComputerKeyboard}, Converter={StaticResource EnumToBooleanConverter}, Mode=TwoWay}" />
                        </MenuItem>
                        <MenuItem Header="調律(_U)">
                            <MenuItem Header="12平均律" Command="{Binding SetTuningSystemCommand}" CommandParameter="{x:Static models:TuningSystemType.TwelveToneEqualTemperament}" IsChecked="{Binding TuningSystem, ConverterParameter={x:Static models:TuningSystemType.TwelveToneEqualTemperament}, Converter={StaticResource EnumToBooleanConverter}}" Style="{StaticResource RadioMenuItemStyle}" />
                            <MenuItem Header="24平均律" Command="{Binding SetTuningSystemCommand}" CommandParameter="{x:Static models:TuningSystemType.TwentyFourToneEqualTemperament}" IsChecked="{Binding TuningSystem, ConverterParameter={x:Static models:TuningSystemType.TwentyFourToneEqualTemperament}, Converter={StaticResource EnumToBooleanConverter}}" Style="{StaticResource RadioMenuItemStyle}" />
                            <MenuItem Header="純正律" Command="{Binding SetTuningSystemCommand}" CommandParameter="{x:Static models:TuningSystemType.JustIntonation}" IsChecked="{Binding TuningSystem, ConverterParameter={x:Static models:TuningSystemType.JustIntonation}, Converter={StaticResource EnumToBooleanConverter}}" Style="{StaticResource RadioMenuItemStyle}" />
                            <MenuItem Header="微分音" Command="{Binding SetTuningSystemCommand}" CommandParameter="{x:Static models:TuningSystemType.Microtonal}" IsChecked="{Binding TuningSystem, ConverterParameter={x:Static models:TuningSystemType.Microtonal}, Converter={StaticResource EnumToBooleanConverter}}" Style="{StaticResource RadioMenuItemStyle}" />
                        </MenuItem>
                        <MenuItem Header="キーボードマッピング" Command="{Binding OpenKeyboardMappingCommand}" />
                        <MenuItem Header="再生中に鍵盤を鳴らす" IsCheckable="True" IsChecked="{Binding LightUpKeyboardDuringPlayback, Mode=TwoWay}" />
                    </MenuItem>
                    <MenuItem Header="ヘルプ(_H)">
                        <MenuItem Header="ショートカットキー" Command="{Binding ShowShortcutHelpCommand}" />
                    </MenuItem>
                </Menu>

                <ToolBarTray DockPanel.Dock="{Binding ToolbarDock}" Background="{DynamicResource {x:Static SystemColors.WindowBrushKey}}">
                    <ToolBarTray.Style>
                        <Style TargetType="ToolBarTray">
                            <Setter Property="Orientation" Value="Horizontal" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding ToolbarDock}" Value="Left">
                                    <Setter Property="Orientation" Value="Vertical" />
                                </DataTrigger>
                                <DataTrigger Binding="{Binding ToolbarDock}" Value="Right">
                                    <Setter Property="Orientation" Value="Vertical" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ToolBarTray.Style>
                    <ToolBar>
                        <Button Command="{Binding SaveCommand}" ToolTip="保存" Style="{StaticResource ToolButtonStyle}">
                            <Path Data="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z" Style="{StaticResource IconPathStyle}" />
                        </Button>
                        <Button Command="{Binding SaveAsCommand}" ToolTip="名前を付けて保存" Style="{StaticResource ToolButtonStyle}">
                            <Path Data="M17,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3M15,15H9V19H15V15M12,2A3,3 0 0,1 15,5H9A3,3 0 0,1 12,2Z" Style="{StaticResource IconPathStyle}" />
                        </Button>
                        <Separator />
                        <Button Command="{Binding PlayPauseCommand}" ToolTip="再生/一時停止" Style="{StaticResource ToolButtonStyle}">
                            <Path Data="{Binding PlayButtonIcon}" Style="{StaticResource IconPathStyle}" />
                        </Button>
                        <Button Command="{Binding StopCommand}" ToolTip="停止" Style="{StaticResource ToolButtonStyle}">
                            <Path Data="M18,18H6V6H18V18Z" Style="{StaticResource IconPathStyle}" />
                        </Button>
                        <Button Command="{Binding RewindCommand}" ToolTip="最初に戻る" Style="{StaticResource ToolButtonStyle}">
                            <Path Data="M11,18V6L2.5,12L11,18M11.5,12L20,18V6L11.5,12Z" Style="{StaticResource IconPathStyle}" />
                        </Button>
                        <Separator />
                        <TextBlock Text="時間:" VerticalAlignment="Center" Margin="5,0" />
                        <TextBlock Text="{Binding CurrentTime, StringFormat='{}{0:mm\\:ss\\.fff}'}" VerticalAlignment="Center" MinWidth="80" />
                        <TextBlock Text="{Binding LoopRangeText}" Foreground="DodgerBlue" VerticalAlignment="Center" Margin="5,0" />
                        <Separator />
                        <Button Command="{Binding OpenQuantizeSettingsCommand}" ToolTip="クオンタイズ設定" Style="{StaticResource ToolButtonStyle}">
                            <Path Data="M6 13h12v-2H6v2zm-4-4h12V7H2v2zm4 8h12v-2H6v2z" Style="{StaticResource IconPathStyle}" />
                        </Button>
                        <Separator />
                        <Button Command="{Binding ZoomInCommand}" ToolTip="拡大" Style="{StaticResource ToolButtonStyle}">
                            <Path Data="M15.5,14H14.71L14.43,13.73C15.41,12.59 16,11.11 16,9.5C16,5.91 13.09,3 9.5,3S3,5.91 3,9.5C3,13.09 5.91,16 9.5,16C11.11,16 12.59,15.41 13.73,14.43L14,14.71V15.5L19,20.49L20.49,19L15.5,14M9.5,14C7,14 5,12 5,9.5S7,5 9.5,5S14,7 14,9.5S12,14 9.5,14M10.5,9H12.5V10H10.5V12H9.5V10H7.5V9H9.5V7H10.5V9Z" Style="{StaticResource IconPathStyle}" />
                        </Button>
                        <Button Command="{Binding ZoomOutCommand}" ToolTip="縮小" Style="{StaticResource ToolButtonStyle}">
                            <Path Data="M15.5,14H14.71L14.43,13.73C15.41,12.59 16,11.11 16,9.5C16,5.91 13.09,3 9.5,3S3,5.91 3,9.5C3,13.09 5.91,16 9.5,16C11.11,16 12.59,15.41 13.73,14.43L14,14.71V15.5L19,20.49L20.49,19L15.5,14M9.5,14C7,14 5,12 5,9.5S7,5 9.5,5S14,7 14,9.5S12,14 9.5,14M7,9H12V10H7V9Z" Style="{StaticResource IconPathStyle}" />
                        </Button>
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <Slider Value="{Binding HorizontalZoom, Mode=TwoWay}" Minimum="10" Maximum="1000" Width="100" VerticalAlignment="Center" ToolTip="水平ズーム">
                                <i:Interaction.Triggers>
                                    <i:EventTrigger EventName="PreviewMouseLeftButtonDown">
                                        <i:InvokeCommandAction Command="{Binding SliderDragStartedCommand}" />
                                    </i:EventTrigger>
                                    <i:EventTrigger EventName="PreviewMouseLeftButtonUp">
                                        <i:InvokeCommandAction Command="{Binding SliderDragCompletedCommand}" />
                                    </i:EventTrigger>
                                </i:Interaction.Triggers>
                            </Slider>
                            <Grid VerticalAlignment="Center" Margin="5,0,0,0" MinWidth="30">
                                <TextBlock Text="{Binding HorizontalZoom, StringFormat='{}{0:F1}x'}" 
                                           Visibility="{Binding IsEditingHorizontalZoom, Converter={StaticResource BooleanToVisibilityInvertedConverter}}"
                                           Cursor="Hand" ToolTip="ダブルクリックで値を入力">
                                    <TextBlock.InputBindings>
                                        <MouseBinding MouseAction="LeftDoubleClick" Command="{Binding StartEditingHorizontalZoomCommand}" />
                                    </TextBlock.InputBindings>
                                </TextBlock>
                                <TextBox Text="{Binding TempHorizontalZoomInput, UpdateSourceTrigger=PropertyChanged}" 
                                         Visibility="{Binding IsEditingHorizontalZoom, Converter={StaticResource BooleanToVisibilityConverter}}"
                                         Width="40">
                                    <TextBox.InputBindings>
                                        <KeyBinding Key="Enter" Command="{Binding FinishEditingHorizontalZoomCommand}" />
                                    </TextBox.InputBindings>
                                    <i:Interaction.Triggers>
                                        <i:EventTrigger EventName="LostFocus">
                                            <i:InvokeCommandAction Command="{Binding FinishEditingHorizontalZoomCommand}" />
                                        </i:EventTrigger>
                                    </i:Interaction.Triggers>
                                </TextBox>
                            </Grid>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="5,0,0,0">
                            <Slider Value="{Binding VerticalZoom, Mode=TwoWay}" Minimum="0.5" Maximum="5" Width="100" VerticalAlignment="Center" ToolTip="垂直ズーム">
                                <i:Interaction.Triggers>
                                    <i:EventTrigger EventName="PreviewMouseLeftButtonDown">
                                        <i:InvokeCommandAction Command="{Binding SliderDragStartedCommand}" />
                                    </i:EventTrigger>
                                    <i:EventTrigger EventName="PreviewMouseLeftButtonUp">
                                        <i:InvokeCommandAction Command="{Binding SliderDragCompletedCommand}" />
                                    </i:EventTrigger>
                                </i:Interaction.Triggers>
                            </Slider>
                            <Grid VerticalAlignment="Center" Margin="5,0,0,0" MinWidth="30">
                                <TextBlock Text="{Binding VerticalZoom, StringFormat='{}{0:F1}x'}" 
                                           Visibility="{Binding IsEditingVerticalZoom, Converter={StaticResource BooleanToVisibilityInvertedConverter}}"
                                           Cursor="Hand" ToolTip="ダブルクリックで値を入力">
                                    <TextBlock.InputBindings>
                                        <MouseBinding MouseAction="LeftDoubleClick" Command="{Binding StartEditingVerticalZoomCommand}" />
                                    </TextBlock.InputBindings>
                                </TextBlock>
                                <TextBox Text="{Binding TempVerticalZoomInput, UpdateSourceTrigger=PropertyChanged}" 
                                         Visibility="{Binding IsEditingVerticalZoom, Converter={StaticResource BooleanToVisibilityConverter}}"
                                         Width="40">
                                    <TextBox.InputBindings>
                                        <KeyBinding Key="Enter" Command="{Binding FinishEditingVerticalZoomCommand}" />
                                    </TextBox.InputBindings>
                                    <i:Interaction.Triggers>
                                        <i:EventTrigger EventName="LostFocus">
                                            <i:InvokeCommandAction Command="{Binding FinishEditingVerticalZoomCommand}" />
                                        </i:EventTrigger>
                                    </i:Interaction.Triggers>
                                </TextBox>
                            </Grid>
                        </StackPanel>
                        <Separator />
                        <TextBlock Text="音量:" VerticalAlignment="Center" Margin="5,0" />
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <Slider Value="{Binding MasterVolume, Mode=TwoWay}" Minimum="0" Maximum="2.0" Width="80" VerticalAlignment="Center" ToolTip="マスターボリューム" />
                            <TextBlock Text="{Binding MasterVolume, StringFormat='{}{0:P0}'}" VerticalAlignment="Center" Margin="5,0,0,0" MinWidth="35" />
                        </StackPanel>
                        <Separator />
                        <CheckBox IsChecked="{Binding GpuAcceleration}" VerticalAlignment="Center" ToolTip="GPUアクセラレーションを有効にします（試験的）" Margin="5,0,0,0">
                            <TextBlock Text="GPU" VerticalAlignment="Center" />
                        </CheckBox>
                        <StackPanel VerticalAlignment="Center" Margin="5,0,0,0">
                            <StackPanel.Style>
                                <Style TargetType="StackPanel">
                                    <Setter Property="Orientation" Value="Horizontal" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=ToolBarTray}, Path=Orientation}" Value="Vertical">
                                            <Setter Property="Orientation" Value="Vertical" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </StackPanel.Style>
                            <CheckBox IsChecked="{Binding IsMidiInputEnabled}" VerticalAlignment="Center" ToolTip="MIDIキーボード入力を有効にします" Margin="0,0,5,0">
                                <TextBlock Text="MIDI In" VerticalAlignment="Center">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=ToolBarTray}, Path=Orientation}" Value="Vertical">
                                                    <Setter Property="Margin" Value="0,5" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </CheckBox>
                            <ComboBox ItemsSource="{Binding MidiInputDevices}" SelectedItem="{Binding SelectedMidiInputDevice}" MinWidth="120" IsEnabled="{Binding IsMidiInputEnabled}">
                                <ComboBox.Style>
                                    <Style TargetType="ComboBox" BasedOn="{StaticResource {x:Type ComboBox}}">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=ToolBarTray}, Path=Orientation}" Value="Vertical">
                                                <Setter Property="Margin" Value="0,5,0,0" />
                                                <Setter Property="Width" Value="120" />
                                                <Setter Property="MinWidth" Value="120" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </ComboBox.Style>
                            </ComboBox>
                        </StackPanel>
                    </ToolBar>
                </ToolBarTray>

                <avalonDock:DockingManager x:Name="DockingManager" Visibility="{Binding IsMidiFileLoaded, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <avalonDock:DockingManager.Resources>
                        <ResourceDictionary>
                            <ResourceDictionary.MergedDictionaries>
                                <ResourceDictionary Source="MidiEditor/Resources/MidiEditorResources.xaml" />
                            </ResourceDictionary.MergedDictionaries>
                        </ResourceDictionary>
                    </avalonDock:DockingManager.Resources>
                    <avalonDock:DockingManager.Theme>
                        <avalonDockThemes:GenericTheme />
                    </avalonDock:DockingManager.Theme>
                    <avalonDockLayout:LayoutRoot>
                        <avalonDockLayout:LayoutPanel Orientation="Horizontal">
                            <avalonDockLayout:LayoutAnchorablePane>
                                <avalonDockLayout:LayoutAnchorable ContentId="pianoRoll" Title="MIDIエディター" CanClose="False">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="*" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition x:Name="PianoKeysColumn" Width="120" MinWidth="50" MaxWidth="400"/>
                                            <ColumnDefinition Width="5"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>

                                        <Border Grid.Row="0" Grid.Column="0" Background="{DynamicResource {x:Static SystemColors.ControlBrushKey}}" BorderBrush="#B0B0B0" BorderThickness="0,0,1,1"/>

                                        <ScrollViewer Grid.Row="1" Grid.Column="0" Name="PianoKeysScrollViewer" VerticalScrollBarVisibility="Hidden" HorizontalScrollBarVisibility="Disabled" ScrollChanged="PianoRollScrollViewer_ScrollChanged">
                                            <ItemsControl ItemsSource="{Binding PianoKeys}" VirtualizingStackPanel.IsVirtualizing="True" VirtualizingStackPanel.VirtualizationMode="Recycling">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <VirtualizingStackPanel />
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Grid Height="{Binding Height}" PreviewMouseDown="PianoKey_PreviewMouseDown" PreviewMouseUp="PianoKey_PreviewMouseUp" MouseEnter="PianoKey_MouseEnter" MouseLeave="PianoKey_MouseLeave">
                                                            <Border BorderBrush="#B0B0B0" BorderThickness="0,0,1,1">
                                                                <Border.Style>
                                                                    <Style TargetType="Border">
                                                                        <Setter Property="Background">
                                                                            <Setter.Value>
                                                                                <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                                                                    <GradientStop Color="#FFFFFF" Offset="0.0" />
                                                                                    <GradientStop Color="#E8E8E8" Offset="1.0" />
                                                                                </LinearGradientBrush>
                                                                            </Setter.Value>
                                                                        </Setter>
                                                                        <Setter Property="Effect">
                                                                            <Setter.Value>
                                                                                <DropShadowEffect ShadowDepth="2" Direction="270" Color="Black" Opacity="0.2" BlurRadius="2" />
                                                                            </Setter.Value>
                                                                        </Setter>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding IsBlackKey}" Value="True">
                                                                                <Setter Property="Background">
                                                                                    <Setter.Value>
                                                                                        <LinearGradientBrush StartPoint="0.5,0" EndPoint="0.5,1">
                                                                                            <GradientStop Color="#555555" Offset="0.0" />
                                                                                            <GradientStop Color="#222222" Offset="1.0" />
                                                                                        </LinearGradientBrush>
                                                                                    </Setter.Value>
                                                                                </Setter>
                                                                                <Setter Property="Panel.ZIndex" Value="1" />
                                                                                <Setter Property="Margin" Value="0,0,40,0" />
                                                                                <Setter Property="BorderThickness" Value="0" />
                                                                                <Setter Property="Effect">
                                                                                    <Setter.Value>
                                                                                        <DropShadowEffect ShadowDepth="3" Direction="270" Color="Black" Opacity="0.5" BlurRadius="4" />
                                                                                    </Setter.Value>
                                                                                </Setter>
                                                                            </DataTrigger>
                                                                            <DataTrigger Binding="{Binding IsPressed}" Value="True">
                                                                                <Setter Property="Background">
                                                                                    <Setter.Value>
                                                                                        <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                                                                            <GradientStop Color="#AAAAAA" Offset="0.0" />
                                                                                            <GradientStop Color="#888888" Offset="1.0" />
                                                                                        </LinearGradientBrush>
                                                                                    </Setter.Value>
                                                                                </Setter>
                                                                                <Setter Property="Effect" Value="{x:Null}" />
                                                                            </DataTrigger>
                                                                            <MultiDataTrigger>
                                                                                <MultiDataTrigger.Conditions>
                                                                                    <Condition Binding="{Binding IsPressed}" Value="True" />
                                                                                    <Condition Binding="{Binding IsBlackKey}" Value="True" />
                                                                                </MultiDataTrigger.Conditions>
                                                                                <Setter Property="Background">
                                                                                    <Setter.Value>
                                                                                        <LinearGradientBrush StartPoint="0.5,0" EndPoint="0.5,1">
                                                                                            <GradientStop Color="#333333" Offset="0.0" />
                                                                                            <GradientStop Color="#111111" Offset="1.0" />
                                                                                        </LinearGradientBrush>
                                                                                    </Setter.Value>
                                                                                </Setter>
                                                                                <Setter Property="Effect" Value="{x:Null}" />
                                                                            </MultiDataTrigger>
                                                                            <DataTrigger Binding="{Binding IsKeyboardPlaying}" Value="True">
                                                                                <Setter Property="Background" Value="OrangeRed" />
                                                                            </DataTrigger>
                                                                            <MultiDataTrigger>
                                                                                <MultiDataTrigger.Conditions>
                                                                                    <Condition Binding="{Binding IsKeyboardPlaying}" Value="True" />
                                                                                    <Condition Binding="{Binding IsBlackKey}" Value="True" />
                                                                                </MultiDataTrigger.Conditions>
                                                                                <Setter Property="Background" Value="DarkRed" />
                                                                            </MultiDataTrigger>
                                                                            <DataTrigger Binding="{Binding IsPlaying}" Value="True">
                                                                                <Setter Property="Background" Value="LightGreen" />
                                                                            </DataTrigger>
                                                                            <MultiDataTrigger>
                                                                                <MultiDataTrigger.Conditions>
                                                                                    <Condition Binding="{Binding IsPlaying}" Value="True" />
                                                                                    <Condition Binding="{Binding IsBlackKey}" Value="True" />
                                                                                </MultiDataTrigger.Conditions>
                                                                                <Setter Property="Background" Value="DarkGreen" />
                                                                            </MultiDataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </Border.Style>
                                                                <Viewbox Stretch="Uniform" StretchDirection="Both">
                                                                    <Grid Width="100" Height="18">
                                                                        <Grid.ColumnDefinitions>
                                                                            <ColumnDefinition Width="*" />
                                                                            <ColumnDefinition Width="*" />
                                                                        </Grid.ColumnDefinitions>
                                                                        <TextBlock Text="{Binding NoteName}" VerticalAlignment="Center" HorizontalAlignment="Left" Margin="5,0">
                                                                            <TextBlock.Style>
                                                                                <Style TargetType="TextBlock">
                                                                                    <Setter Property="Foreground" Value="Black" />
                                                                                    <Style.Triggers>
                                                                                        <DataTrigger Binding="{Binding IsBlackKey}" Value="True">
                                                                                            <Setter Property="Foreground" Value="White" />
                                                                                        </DataTrigger>
                                                                                        <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                                                            <Setter Property="Foreground" Value="White" />
                                                                                        </DataTrigger>
                                                                                        <DataTrigger Binding="{Binding IsPressed}" Value="True">
                                                                                            <Setter Property="Foreground" Value="White" />
                                                                                        </DataTrigger>
                                                                                        <DataTrigger Binding="{Binding IsKeyboardPlaying}" Value="True">
                                                                                            <Setter Property="Foreground" Value="White" />
                                                                                        </DataTrigger>
                                                                                        <DataTrigger Binding="{Binding IsPlaying}" Value="True">
                                                                                            <Setter Property="Foreground" Value="Black" />
                                                                                        </DataTrigger>
                                                                                        <MultiDataTrigger>
                                                                                            <MultiDataTrigger.Conditions>
                                                                                                <Condition Binding="{Binding IsPlaying}" Value="True" />
                                                                                                <Condition Binding="{Binding IsBlackKey}" Value="True" />
                                                                                            </MultiDataTrigger.Conditions>
                                                                                            <Setter Property="Foreground" Value="White" />
                                                                                        </MultiDataTrigger>
                                                                                    </Style.Triggers>
                                                                                </Style>
                                                                            </TextBlock.Style>
                                                                        </TextBlock>
                                                                        <TextBlock Grid.Column="1" Text="{Binding AdditionalNoteName}" VerticalAlignment="Center" HorizontalAlignment="Right" Margin="5,0" Foreground="Gray" />
                                                                    </Grid>
                                                                </Viewbox>
                                                            </Border>
                                                        </Grid>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>

                                        <GridSplitter Grid.Row="0" Grid.RowSpan="2" Grid.Column="1" Width="5" HorizontalAlignment="Center" VerticalAlignment="Stretch" ResizeBehavior="PreviousAndNext" ShowsPreview="True" Background="{DynamicResource {x:Static SystemColors.ControlBrushKey}}"/>

                                        <ScrollViewer Grid.Row="0" Grid.Column="2" Name="RulerScrollViewer" HorizontalScrollBarVisibility="Hidden" VerticalScrollBarVisibility="Hidden" ScrollChanged="PianoRollScrollViewer_ScrollChanged" PreviewMouseDown="TimeBar_MouseDown" PreviewMouseMove="TimeBar_MouseMove" PreviewMouseUp="TimeBar_MouseUp">
                                            <Grid Width="{Binding PianoRollWidth}">
                                                <ItemsControl ItemsSource="{Binding TimeRuler}">
                                                    <ItemsControl.ItemsPanel>
                                                        <ItemsPanelTemplate>
                                                            <StackPanel Orientation="Horizontal" />
                                                        </ItemsPanelTemplate>
                                                    </ItemsControl.ItemsPanel>
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <Border Width="{Binding Width}" Height="20" BorderBrush="#B0B0B0" BorderThickness="0,0,1,1">
                                                                <TextBlock Text="{Binding TimeLabel}" Margin="2,2,0,0" />
                                                            </Border>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                                <Canvas>
                                                    <Rectangle Fill="#330078D7" Height="20"
                                                               Visibility="{Binding IsLooping, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                               Width="{Binding LoopDurationWidth}"
                                                               Canvas.Left="{Binding LoopStartX}" />
                                                </Canvas>
                                            </Grid>
                                        </ScrollViewer>

                                        <ScrollViewer Grid.Row="1" Grid.Column="2" Name="PianoRollScrollViewer" HorizontalScrollBarVisibility="Visible" VerticalScrollBarVisibility="Auto" ScrollChanged="PianoRollScrollViewer_ScrollChanged" PreviewMouseWheel="PianoRollScrollViewer_PreviewMouseWheel">
                                            <Grid MouseLeftButtonDown="PianoRoll_MouseDown" MouseMove="PianoRoll_MouseMove" MouseLeftButtonUp="PianoRoll_MouseUp" MouseRightButtonDown="PianoRoll_MouseRightButtonDown" Background="Transparent">
                                                <Grid.ContextMenu>
                                                    <ContextMenu>
                                                        <MenuItem Header="選択">
                                                            <MenuItem Header="すべて選択" Command="{Binding SelectAllCommand}" />
                                                            <MenuItem Header="選択を反転" Command="{Binding InvertSelectionCommand}" />
                                                            <MenuItem Header="同じ音程のノートを選択" Command="{Binding SelectSamePitchCommand}" />
                                                            <MenuItem Header="同じチャンネルのノートを選択" Command="{Binding SelectSameChannelCommand}" />
                                                        </MenuItem>
                                                        <MenuItem Header="編集">
                                                            <MenuItem Header="移調(トランスポーズ)" Command="{Binding TransposeCommand}" />
                                                            <MenuItem Header="ベロシティの変更" Command="{Binding ChangeVelocityCommand}" />
                                                            <MenuItem Header="レガート" Command="{Binding LegatoCommand}" />
                                                            <MenuItem Header="スタッカート" Command="{Binding StaccatoCommand}" />
                                                            <MenuItem Header="ヒューマナイズ" Command="{Binding HumanizeCommand}" />
                                                            <Separator />
                                                            <MenuItem Header="長さを倍増" Command="{Binding DoubleDurationCommand}" />
                                                            <MenuItem Header="長さを半減" Command="{Binding HalveDurationCommand}" />
                                                            <MenuItem Header="ピッチを反転" Command="{Binding InvertPitchCommand}" />
                                                            <MenuItem Header="逆再生" Command="{Binding RetrogradeCommand}" />
                                                        </MenuItem>
                                                        <Separator />
                                                        <MenuItem Header="ノートを追加" Command="{Binding AddNoteCommand}" IsEnabled="{Binding CanAddNote}" />
                                                        <MenuItem Header="ノートを削除" Command="{Binding DeleteNoteCommand}" IsEnabled="{Binding CanDeleteNote}" />
                                                        <MenuItem Header="ノートを分割" Command="{Binding SplitSelectedNotesCommand}" IsEnabled="{Binding CanSplitNotes}" />
                                                        <MenuItem Header="ノートを結合" Command="{Binding MergeSelectedNotesCommand}" IsEnabled="{Binding CanMergeNotes}" />
                                                        <Separator />
                                                        <MenuItem Header="コピー" Command="{Binding CopyCommand}" />
                                                        <MenuItem Header="貼り付け" Command="{Binding PasteCommand}" />
                                                        <Separator />
                                                        <MenuItem Header="再生">
                                                            <MenuItem Header="選択範囲をループ再生" Command="{Binding LoopSelectionCommand}" />
                                                            <MenuItem Header="再生カーソルを選択ノートの先頭に移動" Command="{Binding SetPlayheadToNoteStartCommand}" />
                                                        </MenuItem>
                                                        <Separator />
                                                        <MenuItem Header="クオンタイズを実行" Command="{Binding QuantizeCommand}" />
                                                        <MenuItem Header="クオンタイズ設定" Command="{Binding OpenQuantizeSettingsCommand}" />
                                                        <Separator />
                                                        <MenuItem Header="表示">
                                                            <MenuItem Header="選択範囲にズーム" Command="{Binding ZoomToSelectionCommand}" />
                                                            <MenuItem Header="ズームをリセット" Command="{Binding ResetZoomCommand}" Visibility="{Binding IsZoomed, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                                            <MenuItem Header="チャンネルごとに自動色分け" Command="{Binding ColorizeByChannelCommand}" />
                                                        </MenuItem>
                                                        <Separator />
                                                        <MenuItem Header="フラグ">
                                                            <MenuItem Header="ここにフラグを追加" Command="{Binding AddFlagCommand}" />
                                                            <MenuItem Header="選択ノート範囲をフラグで囲む" Command="{Binding CreateFlagsFromSelectionCommand}" />
                                                            <MenuItem Header="名前の変更" Command="{Binding RenameFlagCommand}" IsEnabled="{Binding SelectedFlags.Count}" />
                                                            <MenuItem Header="削除" Command="{Binding DeleteSelectedFlagsCommand}" IsEnabled="{Binding SelectedFlags.Count}" />
                                                        </MenuItem>
                                                    </ContextMenu>
                                                </Grid.ContextMenu>

                                                <Image Source="{Binding PianoRollBitmap}" Width="{Binding PianoRollWidth}" Height="{Binding PianoRollHeight}" Stretch="Fill" />

                                                <ItemsControl ItemsSource="{Binding EditingNotes}">
                                                    <ItemsControl.ItemsPanel>
                                                        <ItemsPanelTemplate>
                                                            <Canvas />
                                                        </ItemsPanelTemplate>
                                                    </ItemsControl.ItemsPanel>
                                                    <ItemsControl.ItemContainerStyle>
                                                        <Style TargetType="ContentPresenter">
                                                            <Setter Property="Canvas.Left" Value="{Binding X}" />
                                                            <Setter Property="Canvas.Top" Value="{Binding Y}" />
                                                        </Style>
                                                    </ItemsControl.ItemContainerStyle>
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <Grid>
                                                                <Rectangle Width="{Binding Width}" Height="{Binding Height}" RadiusX="1" RadiusY="1">
                                                                    <Rectangle.Style>
                                                                        <Style TargetType="Rectangle">
                                                                            <Setter Property="Fill" Value="{Binding FillBrush}" />
                                                                            <Setter Property="Stroke" Value="#357ABD" />
                                                                            <Setter Property="StrokeThickness" Value="1" />
                                                                            <Style.Triggers>
                                                                                <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                                                    <Setter Property="Stroke" Value="Orange" />
                                                                                    <Setter Property="StrokeThickness" Value="2" />
                                                                                </DataTrigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </Rectangle.Style>
                                                                    <Rectangle.ToolTip>
                                                                        <ToolTip>
                                                                            <StackPanel>
                                                                                <TextBlock FontWeight="Bold" Text="{Binding NoteName, StringFormat='Note: {0}'}" />
                                                                                <TextBlock Text="{Binding NoteNumber, StringFormat='Note Number: {0}'}" />
                                                                                <TextBlock Text="{Binding Velocity, StringFormat='Velocity: {0}'}" />
                                                                                <TextBlock Text="{Binding StartTime, StringFormat='Start: {0:mm\\:ss\\.fff}'}" />
                                                                                <TextBlock Text="{Binding Duration, StringFormat='Duration: {0:F3}s'}" />
                                                                                <TextBlock Text="{Binding StartTicks, StringFormat='Start Ticks: {0}'}" />
                                                                                <TextBlock Text="{Binding DurationTicks, StringFormat='Duration Ticks: {0}'}" />
                                                                            </StackPanel>
                                                                        </ToolTip>
                                                                    </Rectangle.ToolTip>
                                                                </Rectangle>
                                                                <TextBlock Text="{Binding CentOffsetText}" Foreground="White" FontSize="9" VerticalAlignment="Center" HorizontalAlignment="Right" Margin="0,0,3,0" IsHitTestVisible="False" Visibility="{Binding ShowCentOffset, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                                            </Grid>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>

                                                <Canvas Panel.ZIndex="100">
                                                    <Rectangle Fill="#330066CC" Stroke="#FF0066CC" StrokeThickness="1" StrokeDashArray="2 2" Canvas.Left="{Binding SelectionRectangle.X}" Canvas.Top="{Binding SelectionRectangle.Y}" Width="{Binding SelectionRectangle.Width}" Height="{Binding SelectionRectangle.Height}">
                                                        <Rectangle.Visibility>
                                                            <Binding Path="SelectionRectangle.IsEmpty">
                                                                <Binding.Converter>
                                                                    <editorConverters:BooleanToVisibilityInvertedConverter />
                                                                </Binding.Converter>
                                                            </Binding>
                                                        </Rectangle.Visibility>
                                                    </Rectangle>
                                                </Canvas>

                                                <Canvas Width="{Binding PianoRollWidth}" Height="{Binding PianoRollHeight}" IsHitTestVisible="False">
                                                    <Rectangle Fill="Red" Width="1" Height="{Binding PianoRollHeight}" Canvas.Left="{Binding PlaybackCursorPosition}" />
                                                </Canvas>

                                                <ItemsControl ItemsSource="{Binding Flags}" Panel.ZIndex="10">
                                                    <ItemsControl.ItemsPanel>
                                                        <ItemsPanelTemplate>
                                                            <Canvas />
                                                        </ItemsPanelTemplate>
                                                    </ItemsControl.ItemsPanel>
                                                    <ItemsControl.ItemContainerStyle>
                                                        <Style TargetType="ContentPresenter">
                                                            <Setter Property="Canvas.Left" Value="{Binding X}" />
                                                            <Setter Property="Canvas.Top" Value="{Binding Y}" />
                                                        </Style>
                                                    </ItemsControl.ItemContainerStyle>
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <Grid Background="Transparent" Cursor="SizeWE">
                                                                <Line X1="0" Y1="0" X2="0" Y2="{Binding DataContext.PianoRollHeight, RelativeSource={RelativeSource AncestorType=Canvas}}" StrokeThickness="1" StrokeDashArray="4 2">
                                                                    <Line.Style>
                                                                        <Style TargetType="Line">
                                                                            <Setter Property="Stroke">
                                                                                <Setter.Value>
                                                                                    <SolidColorBrush Color="{Binding DataContext.EditorSettings.Flag.FlagColor, RelativeSource={RelativeSource AncestorType=Window}}"/>
                                                                                </Setter.Value>
                                                                            </Setter>
                                                                            <Style.Triggers>
                                                                                <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                                                    <Setter Property="Stroke">
                                                                                        <Setter.Value>
                                                                                            <SolidColorBrush Color="{Binding DataContext.EditorSettings.Flag.SelectedFlagColor, RelativeSource={RelativeSource AncestorType=Window}}"/>
                                                                                        </Setter.Value>
                                                                                    </Setter>
                                                                                </DataTrigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </Line.Style>
                                                                </Line>
                                                                <Border x:Name="FlagNameBorder" BorderThickness="1" Background="#CCFFFFFF" Padding="2" CornerRadius="3" VerticalAlignment="Top" HorizontalAlignment="Center">
                                                                    <Border.Style>
                                                                        <Style TargetType="Border">
                                                                            <Setter Property="BorderBrush">
                                                                                <Setter.Value>
                                                                                    <SolidColorBrush Color="{Binding DataContext.EditorSettings.Flag.FlagColor, RelativeSource={RelativeSource AncestorType=Window}}"/>
                                                                                </Setter.Value>
                                                                            </Setter>
                                                                            <Style.Triggers>
                                                                                <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                                                    <Setter Property="BorderBrush">
                                                                                        <Setter.Value>
                                                                                            <SolidColorBrush Color="{Binding DataContext.EditorSettings.Flag.SelectedFlagColor, RelativeSource={RelativeSource AncestorType=Window}}"/>
                                                                                        </Setter.Value>
                                                                                    </Setter>
                                                                                </DataTrigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </Border.Style>
                                                                    <Border.RenderTransform>
                                                                        <TranslateTransform Y="{Binding Y}" />
                                                                    </Border.RenderTransform>
                                                                    <TextBlock Text="{Binding Name}" Background="Transparent" Foreground="Black" TextWrapping="NoWrap" MinWidth="30" TextAlignment="Center" />
                                                                </Border>
                                                            </Grid>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </Grid>
                                        </ScrollViewer>

                                        <Grid Grid.Row="2" Grid.Column="2" Height="60" Visibility="{Binding ShowThumbnail, Converter={StaticResource BooleanToVisibilityConverter}}">
                                            <Border Background="#55FFFFFF" BorderBrush="{DynamicResource {x:Static SystemColors.ControlDarkBrushKey}}" BorderThickness="0,1,0,0">
                                                <Canvas Name="ThumbnailCanvas" MouseLeftButtonDown="Thumbnail_MouseDown" MouseMove="Thumbnail_MouseMove" MouseLeftButtonUp="Thumbnail_MouseUp" MouseEnter="Thumbnail_MouseEnter" MouseLeave="Thumbnail_MouseLeave">
                                                    <Image Source="{Binding ThumbnailBitmap}" Stretch="Fill" Width="{Binding ActualWidth, ElementName=ThumbnailCanvas}" Height="{Binding ActualHeight, ElementName=ThumbnailCanvas}" />
                                                    <Rectangle Name="ThumbnailViewport" Fill="#440099FF" Stroke="#FF0099FF" StrokeThickness="1" Cursor="ScrollWE" />
                                                    <Rectangle Name="ThumbnailTimeline" Fill="Red" Width="1" Height="60" />
                                                </Canvas>
                                            </Border>
                                            <Popup Name="ThumbnailPopup" AllowsTransparency="True" IsHitTestVisible="False" Focusable="False">
                                                <Border Background="#CCFFFFFF" BorderBrush="{DynamicResource {x:Static SystemColors.ControlDarkBrushKey}}" BorderThickness="1" CornerRadius="3">
                                                    <Canvas Name="ThumbnailPopupCanvas" Width="300" Height="150" />
                                                </Border>
                                            </Popup>
                                        </Grid>
                                    </Grid>
                                </avalonDockLayout:LayoutAnchorable>
                            </avalonDockLayout:LayoutAnchorablePane>

                            <avalonDockLayout:LayoutAnchorablePaneGroup Orientation="Vertical" DockWidth="250">
                                <avalonDockLayout:LayoutAnchorablePane>
                                    <avalonDockLayout:LayoutAnchorable ContentId="noteEditor" Title="編集" CanClose="False">
                                        <editorPanels:NoteEditorPanel />
                                    </avalonDockLayout:LayoutAnchorable>
                                </avalonDockLayout:LayoutAnchorablePane>
                                <avalonDockLayout:LayoutAnchorablePane>
                                    <avalonDockLayout:LayoutAnchorable ContentId="quantizeSettings" Title="クオンタイズ設定" CanClose="False">
                                        <editorPanels:QuantizeSettingsPanel />
                                    </avalonDockLayout:LayoutAnchorable>
                                    <avalonDockLayout:LayoutAnchorable ContentId="playbackSettings" Title="再生設定" CanClose="False">
                                        <editorPanels:PlaybackSettingsPanel />
                                    </avalonDockLayout:LayoutAnchorable>
                                </avalonDockLayout:LayoutAnchorablePane>
                                <avalonDockLayout:LayoutAnchorablePane>
                                    <avalonDockLayout:LayoutAnchorable ContentId="metronome" Title="メトロノーム" CanClose="False">
                                        <editorPanels:MetronomePanel DataContext="{Binding Metronome}" />
                                    </avalonDockLayout:LayoutAnchorable>
                                </avalonDockLayout:LayoutAnchorablePane>
                                <avalonDockLayout:LayoutAnchorablePane>
                                    <avalonDockLayout:LayoutAnchorable ContentId="soundPeak" Title="サウンドピーク" CanClose="False">
                                        <editorPanels:SoundPeakPanel DataContext="{Binding SoundPeakViewModel}" />
                                    </avalonDockLayout:LayoutAnchorable>
                                </avalonDockLayout:LayoutAnchorablePane>
                                <avalonDockLayout:LayoutAnchorablePane>
                                    <avalonDockLayout:LayoutAnchorable ContentId="tempoEditor" Title="テンポ" CanClose="False">
                                        <editorPanels:TempoEditorPanel />
                                    </avalonDockLayout:LayoutAnchorable>
                                </avalonDockLayout:LayoutAnchorablePane>
                                <avalonDockLayout:LayoutAnchorablePane>
                                    <avalonDockLayout:LayoutAnchorable ContentId="controlChangeEditor" Title="コントロールチェンジ" CanClose="False">
                                        <editorPanels:ControlChangeEditorPanel />
                                    </avalonDockLayout:LayoutAnchorable>
                                </avalonDockLayout:LayoutAnchorablePane>
                            </avalonDockLayout:LayoutAnchorablePaneGroup>
                        </avalonDockLayout:LayoutPanel>
                    </avalonDockLayout:LayoutRoot>
                </avalonDock:DockingManager>
            </DockPanel>
        </DockPanel>
        <Grid Visibility="{Binding IsMidiFileLoaded, Converter={StaticResource BooleanToVisibilityInvertedConverter}}"
              Background="{DynamicResource {x:Static SystemColors.WindowBrushKey}}">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <TextBlock Text="MIDIファイルを開くか、新規作成してください。" FontSize="16" Margin="0,0,0,20" />
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                    <Button Command="{Binding LoadMidiCommand}" Style="{StaticResource RichButtonStyle}" Margin="0,0,10,0">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="M20,6H12L10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6Z" Style="{StaticResource IconPathStyle}" Margin="0,0,5,0"/>
                            <TextBlock Text="MIDIを開く" />
                        </StackPanel>
                    </Button>
                    <Button Command="{Binding LoadProjectCommand}" Style="{StaticResource RichButtonStyle}" Margin="0,0,10,0">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="M20,6H12L10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6Z" Style="{StaticResource IconPathStyle}" Margin="0,0,5,0"/>
                            <TextBlock Text="プロジェクトを開く" />
                        </StackPanel>
                    </Button>
                    <Button Command="{Binding NewCommand}" Style="{StaticResource RichButtonStyle}">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="M19,13H15V11H19V13M19,17H15V15H19V17M15,21H19V19H15V21M5,3H17L21,7V19A2,2 0 0,1 19,21H5A2,2 0 0,1 3,19V5A2,2 0 0,1 5,3M14,8V4H6V8H14Z" Style="{StaticResource IconPathStyle}" Margin="0,0,5,0"/>
                            <TextBlock Text="新規作成" />
                        </StackPanel>
                    </Button>
                </StackPanel>
            </StackPanel>
        </Grid>
    </Grid>
</Window>